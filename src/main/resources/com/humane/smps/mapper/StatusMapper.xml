<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.humane.smps.mapper.StatusMapper">
    <select id="all" resultType="com.humane.smps.dto.StatusDto">
        SELECT
        COUNT(*)                                                AS examinee_cnt,
        COUNT(exam_map.scan_dttm)                               AS attend_cnt,
        COUNT(*) - COUNT(exam_map.scan_dttm)                    AS absent_cnt,
        COUNT(exam_map.scan_dttm) * 100 / COUNT(*)              AS attend_per,
        (COUNT(*) - COUNT(exam_map.scan_dttm)) * 100 / COUNT(*) AS absent_per
        FROM exam_map
        INNER JOIN exam ON exam_map.exam_cd = exam.exam_cd
        INNER JOIN admission ON admission.admission_cd = exam.admission_cd
        INNER JOIN examinee ON examinee.examinee_cd = exam_map.examinee_cd
        INNER JOIN hall ON hall.hall_cd = exam_map.hall_cd
        INNER JOIN exam_hall_date ON exam_hall_date.exam_cd = exam.exam_cd AND exam_hall_date.hall_cd = hall.hall_cd AND exam_hall_date.hall_date = exam_map.hall_date
        <where>
            <if test="param != null">
                <if test="param.userAdmissions != null">AND exam.admission_cd IN (${param.userAdmissions})</if>
                <if test="param.admissionNm != null">AND admission.admission_nm = #{param.admissionNm}</if>
                <if test="param.typeNm != null">AND exam.type_nm = #{param.typeNm} </if>
                <if test="param.examDate != null">AND exam_hall_date.hall_date = #{param.examDate} </if>
                <if test="param.deptNm != null">AND examinee.dept_nm = #{param.deptNm} </if>
                <if test="param.majorNm != null">AND examinee.major_nm = #{param.majorNm} </if>
                <if test="param.headNm != null">AND hall.head_nm = #{param.headNm} </if>
                <if test="param.bldgNm != null">AND hall.bldg_nm = #{param.bldgNm} </if>
                <if test="param.hallNm != null">AND hall.hall_nm = #{param.hallNm} </if>
                <if test="param.groupNm != null">AND exam_map.group_nm LIKE '%' #{param.groupNm} '%' </if>
            </if>
        </where>
    </select>
    <!-- 가번호가 배정된 경우 응시율 요약 -->
    <!-- <select id="all" resultType="com.humane.smps.dto.StatusDto">
         SELECT COUNT(*) AS examinee_cnt
         , COUNT(a.virt_no) AS attend_cnt
         , COUNT(*) - COUNT(a.virt_no) AS absent_cnt
         , COUNT(a.virt_no) * 100 / COUNT(*) AS attend_per
         , (COUNT(*) - COUNT(a.virt_no)) * 100 / COUNT(*) AS absent_per
         FROM exam_map
         INNER JOIN exam ON exam_map.exam_cd = exam.exam_cd AND exam.fk_exam_cd IS NULL
         INNER JOIN admission ON admission.admission_cd = exam.admission_cd
         INNER JOIN examinee ON examinee.examinee_cd = exam_map.examinee_cd
         INNER JOIN hall ON hall.hall_cd = exam_map.hall_cd
         INNER JOIN exam_hall_date ON exam_map.hall_cd = exam_hall_date.hall_cd AND exam_map.hall_date = exam_hall_date.hall_date AND exam_map.exam_cd = exam_hall_date.exam_cd
         LEFT JOIN (SELECT DISTINCT virt_no FROM score
                       WHERE virt_no NOT IN (SELECT virt_no FROM score WHERE total_score = '결시')
                     ) AS a ON a.virt_no = exam_map.examinee_cd
         <where>
             <if test="param != null">
                 <if test="param.userAdmissions != null">AND exam.admission_cd IN (${param.userAdmissions})</if>
                 <if test="param.admissionNm != null">AND admission.admission_nm = #{param.admissionNm}</if>
                 <if test="param.typeNm != null">AND exam.type_nm = #{param.typeNm} </if>
                 <if test="param.examDate != null">AND exam_hall_date.hall_date = #{param.examDate} </if>
                 <if test="param.deptNm != null">AND examinee.dept_nm = #{param.deptNm} </if>
                 <if test="param.majorNm != null">AND examinee.major_nm = #{param.majorNm} </if>
                 <if test="param.headNm != null">AND hall.head_nm = #{param.headNm} </if>
                 <if test="param.bldgNm != null">AND hall.bldg_nm = #{param.bldgNm} </if>
                 <if test="param.hallNm != null">AND hall.hall_nm = #{param.hallNm} </if>
                 <if test="param.groupNm != null">AND exam_map.group_nm LIKE '%' #{param.groupNm} '%' </if>
             </if>
         </where>
     </select>-->

    <select id="dept" resultType="com.humane.smps.dto.StatusDeptDto">
        SELECT *,
        examinee_cnt - absent_cnt                        AS attend_cnt,
        absent_cnt * 100 / examinee_cnt                  AS absent_per,
        (examinee_cnt - absent_cnt) * 100 / examinee_cnt AS attend_per
        FROM (
        SELECT
        admission.admission_nm,
        exam.type_nm,
        exam_hall_date.hall_date AS exam_date,
        examinee.dept_nm,
        COUNT(*) AS examinee_cnt,
        SUM(CASE WHEN exam_map.virt_no IS NULL THEN 1
        WHEN (SELECT COUNT(*) FROM score WHERE exam_map.exam_cd = score.exam_cd AND exam_map.virt_no = score.virt_no) = 0 THEN 1
        WHEN (SELECT COUNT(*) FROM score WHERE exam_map.exam_cd = score.exam_cd AND exam_map.virt_no = score.virt_no AND (score.total_score = '결시' or score.total_score = 'F')) > 0 THEN 1 ELSE 0
        END) AS absent_cnt
        FROM exam_map
        INNER JOIN exam ON exam.exam_cd = exam_map.exam_cd AND exam.fk_exam_cd IS NULL
        INNER JOIN hall ON hall.hall_cd = exam_map.hall_cd
        INNER JOIN exam_hall_date ON exam_hall_date.exam_cd = exam.exam_cd AND exam_hall_date.hall_cd = hall.hall_cd
        INNER JOIN admission ON admission.admission_cd = exam.admission_cd
        INNER JOIN examinee ON examinee.examinee_cd = exam_map.examinee_cd
        <where>
            <if test="param != null">
                <if test="param.admissionNm != null">AND admission.admission_nm = #{param.admissionNm}</if>
                <if test="param.typeNm != null">AND exam.type_nm = #{param.typeNm}</if>
                <if test="param.examNm != null">AND exam.exam_nm = #{param.examNm}</if>
                <if test="param.examDate != null">AND exam_hall_date.hall_date = #{param.examDate}</if>
                <if test="param.deptNm != null">AND examinee.dept_nm = #{param.deptNm}</if>
                <if test="param.userAdmissions != null">AND exam.admission_cd IN (${param.userAdmissions})</if>
            </if>
        </where>
        GROUP BY
        admission.admission_nm,
        exam.type_nm,
        exam_hall_date.hall_date,
        examinee.dept_nm
        ) AS result
    </select>

    <select id="major" resultType="com.humane.smps.dto.StatusMajorDto">
        SELECT *,
        examinee_cnt - absent_cnt                        AS attend_cnt,
        absent_cnt * 100 / examinee_cnt                  AS absent_per,
        (examinee_cnt - absent_cnt) * 100 / examinee_cnt AS attend_per
        FROM (
        SELECT
        admission.admission_nm,
        exam.exam_nm,
        exam.type_nm,
        exam_hall_date.hall_date AS exam_date,
        examinee.dept_nm,
        examinee.major_nm,
        COUNT(*) AS examinee_cnt,
        SUM(CASE WHEN exam_map.virt_no IS NULL THEN 1
        WHEN (SELECT COUNT(*) FROM score WHERE exam_map.exam_cd = score.exam_cd AND exam_map.virt_no = score.virt_no) = 0 THEN 1
        WHEN (SELECT COUNT(*) FROM score WHERE exam_map.exam_cd = score.exam_cd AND exam_map.virt_no = score.virt_no AND (score.total_score = '결시' or score.total_score = 'F')) > 0 THEN 1 ELSE 0
        END) AS absent_cnt
        FROM exam_map
        INNER JOIN exam ON exam.exam_cd = exam_map.exam_cd AND exam.fk_exam_cd IS NULL
        INNER JOIN hall ON hall.hall_cd = exam_map.hall_cd
        INNER JOIN exam_hall_date ON exam_hall_date.exam_cd = exam.exam_cd AND exam_hall_date.hall_cd = hall.hall_cd AND exam_hall_date.hall_date = exam_map.hall_date
        INNER JOIN admission ON admission.admission_cd = exam.admission_cd
        INNER JOIN examinee ON examinee.examinee_cd = exam_map.examinee_cd
        <where>
            <if test="param != null">
                <if test="param.admissionNm != null">AND admission.admission_nm = #{param.admissionNm}</if>
                <if test="param.typeNm != null">AND exam.type_nm = #{param.typeNm}</if>
                <if test="param.examNm != null">AND exam.exam_nm = #{param.examNm}</if>
                <if test="param.examDate != null">AND exam_hall_date.hall_date = #{param.examDate}</if>
                <if test="param.deptNm != null">AND examinee.dept_nm = #{param.deptNm}</if>
                <if test="param.majorNm != null">AND examinee.major_nm = #{param.majorNm}</if>
                <if test="param.userAdmissions != null">AND exam.admission_cd IN (${param.userAdmissions})</if>
            </if>
        </where>
        GROUP BY
        admission.admission_nm,
        exam.type_nm,
        exam_hall_date.hall_date,
        exam.exam_nm,
        examinee.dept_nm,
        examinee.major_nm
        ) AS result
    </select>

    <select id="hall" resultType="com.humane.smps.dto.StatusHallDto">
        SELECT *,
        examinee_cnt - absent_cnt                        AS attend_cnt,
        absent_cnt * 100 / examinee_cnt                  AS absent_per,
        (examinee_cnt - absent_cnt) * 100 / examinee_cnt AS attend_per
        FROM (
        SELECT
        admission.admission_nm,
        --  exam.exam_nm,
        exam.type_nm,
        exam_hall_date.hall_date AS exam_date,
        hall.head_nm,
        hall.bldg_nm,
        hall.hall_nm,
        COUNT(*) AS examinee_cnt,
        SUM(CASE WHEN exam_map.virt_no IS NULL THEN 1
        WHEN (SELECT COUNT(*) FROM score WHERE exam_map.exam_cd = score.exam_cd AND exam_map.virt_no = score.virt_no) = 0 THEN 1
        WHEN (SELECT COUNT(*) FROM score WHERE exam_map.exam_cd = score.exam_cd AND exam_map.virt_no = score.virt_no AND (score.total_score = '결시' or score.total_score = 'F')) > 0 THEN 1 ELSE 0
        END) AS absent_cnt
        FROM exam_map
        INNER JOIN exam ON exam.exam_cd = exam_map.exam_cd AND exam.fk_exam_cd IS NULL
        INNER JOIN hall ON hall.hall_cd = exam_map.hall_cd
        INNER JOIN exam_hall_date ON exam_hall_date.exam_cd = exam.exam_cd AND exam_hall_date.hall_cd = hall.hall_cd AND exam_hall_date.hall_date = exam_map.hall_date
        INNER JOIN admission ON admission.admission_cd = exam.admission_cd
        INNER JOIN examinee ON examinee.examinee_cd = exam_map.examinee_cd
        <where>
            <if test="param != null">
                <if test="param.admissionNm != null">AND admission.admission_nm = #{param.admissionNm}</if>
                <if test="param.typeNm != null">AND exam.type_nm = #{param.typeNm}</if>
                <if test="param.examNm != null">AND exam.exam_nm = #{param.examNm}</if>
                <if test="param.examDate != null">AND exam_hall_date.hall_date = #{param.examDate}</if>
                <if test="param.headNm != null">AND hall.head_nm = #{param.headNm}</if>
                <if test="param.bldgNm != null">AND hall.bldg_nm = #{param.bldgNm}</if>
                <if test="param.hallNm != null">AND hall.hall_nm = #{param.hallNm}</if>
                <if test="param.userAdmissions != null">AND exam.admission_cd IN (${param.userAdmissions})</if>
            </if>
        </where>
        GROUP BY
        admission.admission_nm,
        exam.type_nm,
        exam_hall_date.hall_date,
        --     exam.exam_nm,
        hall.head_nm,
        hall.bldg_nm,
        hall.hall_nm
        ) AS result
    </select>

    <select id="group" resultType="com.humane.smps.dto.StatusGroupDto">
        SELECT *,
        examinee_cnt - absent_cnt                        AS attend_cnt,
        absent_cnt * 100 / examinee_cnt                  AS absent_per,
        (examinee_cnt - absent_cnt) * 100 / examinee_cnt AS attend_per
        FROM (
        SELECT
        admission.admission_nm,
        exam.exam_nm,
        exam.type_nm,
        exam_hall_date.hall_date AS exam_date,
        hall.head_nm,
        hall.bldg_nm,
        hall.hall_nm,
        examinee.dept_nm,
        examinee.major_nm,
        exam_map.group_nm,
        COUNT(*) AS examinee_cnt,
        SUM(CASE WHEN exam_map.virt_no IS NULL THEN 1
        WHEN (SELECT COUNT(*) FROM score WHERE exam_map.exam_cd = score.exam_cd AND exam_map.virt_no = score.virt_no) = 0 THEN 1
        WHEN (SELECT COUNT(*) FROM score WHERE exam_map.exam_cd = score.exam_cd AND exam_map.virt_no = score.virt_no AND (score.total_score = '결시' or score.total_score = 'F')) > 0 THEN 1 ELSE 0
        END) AS absent_cnt
        FROM exam_map
        INNER JOIN exam ON exam.exam_cd = exam_map.exam_cd AND exam.fk_exam_cd IS NULL
        INNER JOIN hall ON hall.hall_cd = exam_map.hall_cd
        INNER JOIN exam_hall_date ON exam_hall_date.exam_cd = exam.exam_cd AND exam_hall_date.hall_cd = hall.hall_cd AND exam_hall_date.hall_date = exam_map.hall_date
        INNER JOIN admission ON admission.admission_cd = exam.admission_cd
        INNER JOIN examinee ON examinee.examinee_cd = exam_map.examinee_cd
        <where>
            <if test="param != null">
                <if test="param.admissionNm != null">AND admission.admission_nm = #{param.admissionNm}</if>
                <if test="param.typeNm != null">AND exam.type_nm = #{param.typeNm}</if>
                <if test="param.examNm != null">AND exam.exam_nm = #{param.examNm}</if>
                <if test="param.examDate != null">AND exam_hall_date.hall_date = #{param.examDate}</if>
                <if test="param.deptNm != null">AND examinee.dept_nm = #{param.deptNm}</if>
                <if test="param.majorNm != null">AND examinee.major_nm = #{param.majorNm}</if>
                <if test="param.groupNm != null">AND exam_map.group_nm LIKE '%' #{param.groupNm} '%'</if>
                <if test="param.headNm != null">AND hall.head_nm = #{param.headNm}</if>
                <if test="param.bldgNm != null">AND hall.bldg_nm = #{param.bldgNm}</if>
                <if test="param.hallNm != null">AND hall.hall_nm = #{param.hallNm}</if>
                <if test="param.userAdmissions != null">AND exam.admission_cd IN (${param.userAdmissions})</if>
            </if>
        </where>
        GROUP BY
        admission.admission_nm,
        exam.type_nm,
        exam_hall_date.hall_date,
        exam.exam_nm,
        hall.head_nm,
        hall.bldg_nm,
        hall.hall_nm,
        examinee.dept_nm,
        examinee.major_nm,
        exam_map.group_nm
        ) AS result
    </select>

    <select id="getExamInfo" resultType="com.humane.smps.dto.ExamInfoDto">
        SELECT exam.exam_cd
              , exam.adjust
              , exam.barcode_type
              , exam.exam_nm
              , exam.examinee_len
              , exam.is_absence
              , exam.is_closed_view
              , exam.is_horizontal
              , exam.is_mgr_auto
              , exam.is_move
              , exam.item_cnt
              , exam.keypad_type
              , exam.period
              , exam.print_content1
              , exam.print_content2
              , exam.print_sign
              , exam.print_title1
              , exam.print_title2
              , exam.scorer_cnt
              , exam.tot_score
              , exam.type_nm
              , exam.virt_no_digits
              , exam.virt_no_type
              , exam.fk_exam_cd
              , exam.admission_cd

              , admission.admission_nm

              , exam_hall_date.hall_date
              , exam_hall_date.virt_no_end
              , exam_hall_date.virt_no_start
              , exam_hall_date.hall_cd

              , hall.head_nm
              , hall.bldg_nm
              , hall.hall_nm
           FROM exam
          INNER JOIN admission ON admission.admission_cd = exam.admission_cd
          INNER JOIN exam_hall_date ON exam_hall_date.exam_cd = exam.exam_cd
          INNER JOIN hall ON hall.hall_cd = exam_hall_date.hall_cd
        <where>
            <if test="param != null">
                <if test="param.admissionNm">AND admission.admission_nm = #{param.admissionNm}</if>
                <if test="param.examCd">AND exam.exam_cd = #{param.examCd}</if>
                <if test="param.examNm">AND exam.exam_nm = #{param.examNm}</if>
            </if>
        </where>
    </select>

    <update id="modifyExamInfo">
        <if test="param != null">
            UPDATE exam
            <set>
                <if test="param.typeNm != null">type_nm = #{param.typeNm},</if>
                <if test="param.examNm != null">exam_nm = #{param.examNm},</if>
                <if test="param.period != null">period = #{param.period},</if>
                <if test="param.adjust != null">adjust = #{param.adjust},</if>
                <if test="param.barcodeType != null">barcode_type = #{param.barcodeType},</if>
                <if test="param.examineeLen != null">examinee_len = #{param.examineeLen},</if>
                <if test="param.isAbsence != null">is_absence = #{param.isAbsence},</if>
                <if test="param.isClosedView != null">is_closed_view = #{param.isClosedView},</if>
                <if test="param.isHorizontal != null">is_horizontal = #{param.isHorizontal},</if>
                <if test="param.isMgrAuto != null">is_mgr_auto = #{param.isMgrAuto},</if>
                <if test="param.isMove != null">is_move = #{param.isMove},</if>
                <if test="param.itemCnt != null">item_cnt = #{param.itemCnt},</if>
                <if test="param.keypadType != null">keypad_type = #{param.keypadType},</if>
                <if test="param.printTitle1 != null">print_title1 = #{param.printTitle1},</if>
                <if test="param.printContent1 != null">print_content1 = #{param.printContent1},</if>
                <if test="param.printTitle2 != null">print_title2 = #{param.printTitle2},</if>
                <if test="param.printContent2 != null">print_content2 = #{param.printContent2},</if>
                <if test="param.scorerCnt != null">scorer_cnt = #{param.scorerCnt},</if>
                <if test="param.totScore != null">tot_score = #{param.totScore},</if>
                <if test="param.virtNoDigits != null">virt_no_digits = #{param.virtNoDigits},</if>
                <if test="param.virtNoType != null">virt_no_type = #{param.virtNoType}</if>
            </set>
            WHERE exam_cd = #{param.examCd}
        </if>
    </update>

    <update id="modifyExamHallDateOfExamInfo">
        <if test="param != null">
            UPDATE exam_hall_date
            <set>
                <if test="param.hallDate">hall_date = #{param.hallDate},</if>
                <if test="param.virtNoStart != null">virt_no_start = #{param.virtNoStart},</if>
                <if test="param.virtNoEnd != null">virt_no_end = #{param.virtNoEnd}</if>
            </set>
            WHERE exam_cd = #{param.examCd}
        </if>
    </update>
</mapper>