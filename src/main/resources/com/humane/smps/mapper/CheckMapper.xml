<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.humane.smps.mapper.CheckMapper">
    <select id="send" resultType="com.humane.smps.dto.CheckSendDto">
        SELECT admission.admission_nm,
        exam.type_nm,
        exam_map.hall_date AS exam_date,
        exam.exam_time,
        examinee.dept_nm,
        examinee.major_nm,
        exam.exam_nm,
        score.scorer_nm,
        hall.head_nm,
        hall.bldg_nm,
        hall.hall_nm,
        CASE WHEN sheet.reg_dttm IS NOT NULL THEN TRUE ELSE FALSE END AS isSend,
        sheet.reg_dttm
        FROM exam_map
        INNER JOIN exam ON exam.exam_cd = exam_map.exam_cd
        INNER JOIN admission ON admission.admission_cd = exam.admission_cd
        INNER JOIN examinee ON examinee.examinee_cd = exam_map.examinee_cd
        INNER JOIN exam_hall ON exam_hall.hall_cd = exam_map.hall_cd
        INNER JOIN hall ON hall.hall_cd = exam_hall.hall_cd
        LEFT JOIN score ON score.exam_cd = exam.exam_cd AND score.hall_cd = exam_map.hall_cd
        LEFT JOIN sheet ON sheet.scorer_nm = score.scorer_nm AND sheet.hall_cd = exam_map.hall_cd
        <where>
            <if test="param != null">
                <if test="param.userAdmissions != null">AND admission.admission_cd IN (${param.userAdmissions})</if>
                <if test="param.admissionNm != null">AND admission.admission_nm = #{param.admissionNm}</if>
                <if test="param.typeNm != null">AND exam.type_nm = #{param.typeNm}</if>
                <if test="param.examDate != null">AND exam_map.hall_date = #{param.examDate}</if>
                <if test="param.deptNm != null">AND examinee.dept_nm = #{param.deptNm}</if>
                <if test="param.majorNm != null">AND examinee.major_nm = #{param.majorNm}</if>
                <if test="param.headNm != null">AND hall.head_nm = #{param.headNm}</if>
                <if test="param.bldgNm != null">AND hall.bldg_nm = #{param.bldgNm}</if>
                <if test="param.hallNm != null">AND hall.hall_nm = #{param.hallNm}</if>
                <if test="param.scorerNm != null">AND score.scorer_nm LIKE '%' #{param.scorerNm} '%'</if>
                <if test="param.isSend != null">
                    <if test="param.isSend == true">AND sheet.reg_dttm IS NOT NULL</if>
                    <if test="param.isSend == false">AND sheet.reg_dttm IS NULL</if>
                </if>
            </if>
        </where>
        GROUP BY
        admission.admission_nm,
        examinee.dept_nm,
        examinee.major_nm,
        exam.exam_nm,
        exam_map.hall_date,
        hall.head_nm,
        hall.bldg_nm,
        hall.hall_nm,
        score.scorer_nm
    </select>

    <select id="item" resultType="com.humane.smps.dto.CheckItemDto">
        SELECT *
        FROM
        (SELECT admission.admission_nm
        , exam.type_nm
        , exam_map.hall_date AS exam_date
        , examinee.dept_nm
        , examinee.major_nm
        , exam.exam_nm
        , hall.head_nm
        , hall.bldg_nm
        , hall.hall_nm
        , examinee.examinee_cd
        , exam_map.virt_no
        , score.scorer_nm
        , (SELECT COUNT(*) FROM item WHERE exam.exam_cd = item.exam_cd) AS item_cnt
        , (score.score01 IS NOT NULL)
        + (score.score02 IS NOT NULL)
        + (score.score03 IS NOT NULL)
        + (score.score04 IS NOT NULL)
        + (score.score05 IS NOT NULL)
        + (score.score06 IS NOT NULL)
        + (score.score07 IS NOT NULL)
        + (score.score08 IS NOT NULL)
        + (score.score09 IS NOT NULL)
        + (score.score10 IS NOT NULL) AS scored_cnt
        FROM exam_map
        INNER JOIN exam ON exam_map.exam_cd = exam.exam_cd
        INNER JOIN hall ON exam_map.hall_cd = hall.hall_cd
        INNER JOIN examinee ON exam_map.examinee_cd = examinee.examinee_cd
        INNER JOIN admission ON admission.admission_cd = exam.admission_cd
        LEFT JOIN score ON exam_map.exam_cd = score.exam_cd AND exam_map.virt_no = score.virt_no
        <where>
            <if test="param != null">
                <if test="param.userAdmissions != null">AND admission.admission_cd IN (${param.userAdmissions})</if>
                <if test="param.admissionNm != null">AND admission.admission_nm = #{param.admissionNm}</if>
                <if test="param.typeNm != null">AND exam.type_nm = #{param.typeNm}</if>
                <if test="param.examDate != null">AND exam_map.hall_date = #{param.examDate}</if>
                <if test="param.deptNm != null">AND examinee.dept_nm = #{param.deptNm}</if>
                <if test="param.majorNm != null">AND examinee.major_nm = #{param.majorNm}</if>
                <if test="param.headNm != null">AND hall.head_nm = #{param.headNm}</if>
                <if test="param.bldgNm != null">AND hall.bldg_nm = #{param.bldgNm}</if>
                <if test="param.hallNm != null">AND hall.hall_nm = #{param.hallNm}</if>
                <if test="param.virtNo != null">AND exam_map.virt_no LIKE '%' #{param.virtNo} '%'</if>
                <if test="param.scorerNm != null">AND score.scorer_nm LIKE '%' #{param.scorerNm} '%'</if>
                <if test="param.isVirtNo != null">
                    <if test="param.isVirtNo == true">AND exam_map.virt_no IS NOT NULL</if>
                    <if test="param.isVirtNo == false">AND exam_map.virt_no IS NULL</if>
                </if>
            </if>
        </where>
        GROUP BY
        admission.admission_nm
        , exam.type_nm
        , exam_map.hall_date
        , examinee.dept_nm
        , examinee.major_nm
        , exam.exam_nm
        , hall.head_nm
        , hall.bldg_nm
        , hall.hall_nm
        , examinee.examinee_cd
        , exam_map.virt_no
        , score.scorer_nm
        ) AS result
        WHERE result.item_cnt != scored_cnt AND result.virt_no IS NOT NULL
    </select>

    <select id="scorer" resultType="com.humane.smps.dto.CheckScorerDto">
        select admission.admission_nm
            , exam.type_nm
            , exam.exam_nm
            , exam_map.hall_date as exam_date
            , examinee.dept_nm
            , examinee.major_nm
            , hall.head_nm
            , hall.bldg_nm
            , hall.hall_nm
            , exam_map.examinee_cd
            , exam_map.virt_no
            , exam.scorer_cnt
            , count(score.scorer_nm) as scored_cnt
         from exam_map
         left join score on score.exam_cd = exam_map.exam_cd and score.hall_cd = exam_map.hall_cd and score.virt_no = exam_map.virt_no
        inner join exam on exam_map.exam_cd = exam.exam_cd
        inner join hall on exam_map.hall_cd = hall.hall_cd
        inner join admission on exam.admission_cd = admission.admission_cd
        inner join examinee on exam_map.examinee_cd = examinee.examinee_cd
        <where>
            AND exam_map.virt_no IS NOT NULL
            <if test="param != null">
                <if test="param.userAdmissions != null">AND admission.admission_cd IN (${param.userAdmissions})</if>
                <if test="param.admissionNm != null">AND admission.admission_nm = #{param.admissionNm}</if>
                <if test="param.typeNm != null">AND exam.type_nm = #{param.typeNm}</if>
                <if test="param.examDate != null">AND exam_map.hall_date = #{param.examDate}</if>
                <if test="param.deptNm != null">AND examinee.dept_nm = #{param.deptNm}</if>
                <if test="param.majorNm != null">AND examinee.major_nm = #{param.majorNm}</if>
                <if test="param.headNm != null">AND hall.head_nm = #{param.headNm}</if>
                <if test="param.bldgNm != null">AND hall.bldg_nm = #{param.bldgNm}</if>
                <if test="param.hallNm != null">AND hall.hall_nm = #{param.hallNm}</if>
                <if test="param.virtNo != null">AND exam_map.virt_no LIKE '%' #{param.virtNo} '%'</if>
                <if test="param.isVirtNo != null">
                    <if test="param.isVirtNo == true">AND exam_map.virt_no IS NOT NULL</if>
                    <if test="param.isVirtNo == false">AND exam_map.virt_no IS NULL</if>
                </if>
            </if>
        </where>
        group by admission.admission_nm
            , exam.type_nm
            , exam.exam_nm
            , exam_map.hall_date
            , examinee.dept_nm
            , examinee.major_nm
            , hall.head_nm
            , hall.bldg_nm
            , hall.hall_nm
            , exam_map.examinee_cd
            , exam_map.virt_no
            , exam.scorer_cnt
        having exam.scorer_cnt != count(score.scorer_nm)
        /*having count(*) != count(score.scorer_nm)*/
    </select>
</mapper>